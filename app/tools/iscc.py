# -*- coding: utf-8 -*-
"""
ISCC Reference Implementation
"""
import re
import base64
import struct
from io import BytesIO
from hashlib import sha256, sha1
import unicodedata
from typing import List, ByteString, Sequence, BinaryIO, TypeVar, Generator

# Magic Constants
import math
from PIL import Image

CHUNKING_GEAR = [
    9584138480181866666, 4739450037122062430, 1042006760432515769, 10675154520554330663, 15869016765101259526,
    8970928072383595559, 1399451202205921674, 14523822808097149755, 16268498464839721299, 10481172452375523505,
    17104617054662428007, 1589812074021361642, 5529368114994898429, 16097147859444922117, 7366391750793198740,
    11100538009918328137, 1389689728615383157, 4977138822009172500, 908349889557194910, 14452518814433479233,
    2122926032271239532, 591612022955043504, 9379034436570273189, 12748258297147873806, 4307386326245858243,
    13845229916084989633, 11224472648935237303, 7047696390035316099, 2021133566789993437, 17387162748083618158,
    11746787256992261957, 6644482612611712714, 15729398955930993486, 18187694890389888249, 13375007170405426180,
    4646676434852504131, 13152698236329639071, 899989819383117385, 1604228284900755822, 13429168974601667864,
    3706248770764044735, 3719799868214789934, 339511817415309475, 12306710798301877171, 9844020938499650522,
    13507342816267977422, 15331217600725578556, 7506003564454403634, 17943236144189306428, 282153689319390566,
    7654271695669749695, 2650412143911437370, 6193440044944269691, 9296646612477743744, 15077579129862372948,
    67630558006200567, 11937031764123301943, 1634327986517329169, 16073934395340319514, 11660580892053471307,
    12301495579660351243, 16908718276972184511, 6851717516129410187, 13288278789994352315, 17482170774163197685,
    12177168157992128323, 1679876621412537528, 15666827561093998679, 4235032027386979601, 17396011814487376094,
    2036017399572567727, 4977152437582070133, 11341111713611820820, 5866443846249079891, 5131277185090952872,
    8325299058005558320, 5701450024662049407, 15870252139465586153, 641910037851244477, 5172232175829573378,
    2261684586607900474, 11396825283718526131, 12408680075109652465, 7761877592432080901, 13820035802684848169,
    8150091535052795450, 1103357817677537274, 13470426615970288837, 4696524065622673976, 9336804607285957500,
    13043178028673218162, 7139020806469476608, 12450708403507569100, 2877039905016676547, 15118872351294838361,
    3277072151995360446, 1979210712452295885, 14822651643543876641, 5849754172112174627, 13664543478254756807,
    16186972696580520130, 14259131679517995788, 1772106294408535188, 2668205339646827112, 3734021086026184498,
    4257506854909152229, 6797729639474582495, 3708095106171770747, 15445894064208319783, 11045733249000282278,
    6925260395759991481, 6761677416581440942, 3134957115005596133, 5496794829211694837, 225035875953155227,
    18051382753002575119, 6911658830635795092, 6648838042848840266, 7680838377178993211, 14373546918520540763,
    7385952462173201391, 7500965322394952100, 15539214383494689771, 14355530880918970074, 4040759991734970063,
    1335151750647325670, 13713452291232361388, 8852782707920062625, 6076783566257059794, 14451547968886132839,
    6756882940270420653, 17423128808598833972, 5877907771709558759, 14308413074787508328, 12294727846616188882,
    13766545313722789196, 7000331838802888702, 15110028412924060381, 15869145452552081798, 10836437530623796047,
    1273143868608979117, 17728019699248776702, 379008101491021165, 6658832383485441856, 6005905363267598720,
    4792802520786808134, 17024928019214694263, 7949301678895773307, 14602122883430422290, 6416689239839102410,
    18112987618441438141, 5424513836620859057, 12327961344656070412, 18229731317766561349, 6214341855555485197,
    14659604854593022088, 18341976098904231516, 9093141550798891276, 4487469223051523007, 12576621890114680116,
    11368566035561888278, 16632902625329423294, 13764076000271015053, 11494903226088746337, 14079100963083335535,
    5976601008655555884, 5685807667042201553, 16503266544486236927, 5505089898459277917, 17076606531971661551,
    939769563919939433, 17217248958964594832, 11196454443995107214, 13253314556391295544, 17340262486782904124,
    5483165811177129540, 121736889831618943, 6318157315988658220, 14520375112718267902, 689388276875596813,
    5273319774965020902, 7975410517565653865, 13935269057627157047, 16821796908479891795, 5882048506860913277,
    18003709489856105216, 1424933842252756366, 6634557257081066175, 16179356916240399588, 11153419399622634817,
    15654294493035402949, 2652919763627807814, 16437183290373292867, 16903315446495122175, 3575318971059548300,
    3073697257555445515, 16187136733800880291, 15191964085364171996, 11982016174040399757, 1948589207658719032,
    14444449012119241408, 7130754012353479650, 7480280819583944745, 3603028513293740433, 7021162527209392860,
    2124450348946366496, 14349140477237426219, 7396225914272122063, 16288120608246645021, 7309794834881975478,
    16746864570463829614, 9239996606832866982, 14126189643057989505, 5785181374404079776, 16681042508550037223,
    9085478584447523753, 12879577862603639783, 13351556131001260565, 10860701565908202403, 9109516948909639475,
    2942389181877553466, 1907923359833671766, 1700327967934711796, 4355952370607563279, 6159416062364401684,
    8120694842642123744, 4670360822544180192, 12684384265447906291, 11518186189217338692, 14839496566538901930,
    13515715604989800698, 12135065096961528408, 9056982071865174221, 12690699907549395246, 2080896935929507230,
    14546126411900211421, 6222235617711806766, 13387691023848518640, 1259523422199249803, 1733690531272524911,
    16691543548458831721, 3252085970219428027, 790320086519395195, 8366099548552136926, 357423734596052102,
    6375583027298966643, 88639135753272123, 13813972796887520980, 8203570281250814300, 18377325011640278855,
    2922465295015278442, 2164203008979443347, 7447171935848155518, 3663261456454345351, 5865411828910435346,
    13570376904595974307
]
MINHASH_PERMUTATIONS = {
    1: [[775169054918279404, 2109959069025162, 401325382989534145, 1130051441076870728, 401538927472639258,
         815244983797985638, 1465635305079316733, 505211975917066639, 780385900265431000, 283838892089191903,
         936072031995811818, 1169969703377029950, 25625226007148417, 1568788725991793369, 826975332961259499,
         1814178924063827016, 1529041984443575858, 1233664984050117401, 1134491820483890203, 337359223002198900,
         2100366343476833345, 561592535218511587, 1904183826989973146, 619727673435799236, 696832086074912126,
         357257325660623162, 1598006598579725601, 2150395256084530832, 1367228525499322312, 1647396391822001343,
         1887737050569905304, 1280206955645314894, 921478673934505214, 715634959063503318, 1283796700206534620,
         523922820580841550, 263352056799233068, 418313753765229416, 968612313319578170, 14980651099439201,
         153220345614122877, 17384899557965977, 367604757747313057, 979359603628154429, 709120483056161652,
         2116689543321462493, 1381884949962268343, 611266146699233751, 523509680078012392, 52948149690579846,
         1413848896402184823, 201846032685059982, 618614248984827574, 291850381902561464, 1215583606649627030,
         873278286232559572, 1062448801025099918, 1217488311597731463, 71503144720579472, 1596100048030278083,
         366723709801908645, 522162562461265193, 2029657444881885554, 974393427803837903, 2290593402415132573,
         1581979269522776949, 1125808846525888897, 934007963372074532, 1053404851543353987, 2094477501324246839,
         1037449266289342520, 1105286383762747615, 821837035338323556, 1857759398970506190, 1101583836342502209,
         1327691181208577138, 1256231807310832912, 42902454742971892, 1299194599953098988, 1752809426824068150,
         2118567300926164724, 2212792323624167201, 586447722759106260, 1291680585167188656, 1961432329506782784,
         1242617054144874283, 1471039734164907747, 939828747546450753, 815952863767273618, 1223661685133629085,
         87022673460369867, 50831080378748135, 190280048193181631, 1262389667950943489, 455086835550584084,
         245282199234122804, 2030358702377275717, 605345743814266390, 257361052164127161, 2154180424385901111,
         1386754629279803919, 749055048214673206, 276843534351670230, 1924188903974864429, 944130688119949751,
         366640366875901244, 903072637067301592, 185927603917723085, 397062628907991665, 1422529324905212322,
         944404313172274118, 110622250926641692, 1747582826281098368, 1512894580233772885, 1747542065935107223,
         1565764496068337735, 896577955981603924, 2126052233424800199, 286538330633190807, 1082387680134353146,
         1203554243709668234, 1436212155308104046, 699670876789814989, 994450590275747946, 997394006025442463,
         7416020676747194, 29151700773516035, 1931671111240692334, 1378184067104217417, 656266483234216334,
         401476683897573, 93749729188780967, 2111772807429987689, 844654111594252800, 131022625550821149,
         488462140321785515, 2249015393093666363, 1822576709670243878, 1357124901237839083, 1721934191857838177,
         92202124247812300, 695807772444396065, 43657970185022439, 511244967551784034, 1337177191101975324,
         350702653063128679, 1270205830409028403, 1709808568961855761, 53941540978398654, 1988874757967116649,
         1141091484762014641, 1169767958315762397, 663555870901441170, 1755614450316188701, 1706542676699660114,
         761952944664962647, 131309417604553295, 1253691150354842322, 1910818374364436982, 2269568581611249998,
         753525933718578039, 2004536434701674116, 292510237147392845, 510451834582787472, 811843420564607885,
         360551560871267974, 1790240638031979453, 651096837324789484, 1371745314022079423, 1747083927478378318,
         2151042937325602941, 1409460256069079083, 1821494281817099303, 1448382796469786322, 915240053285801191,
         373338661979513129, 178903767391028687, 134722398134869538, 859409407509646367, 604120105662575428,
         926918225114934626, 485304987267960093, 1839884987832128478, 2193558029896114631, 487472374889820065,
         1949916234231750366, 652925865734739449, 560775352699054110, 2072422578200506268, 1216417804988820626,
         1234166100501400957, 2116795400091020193, 2264022423994314932, 3180435828861190, 1050162702137036183,
         1604131861097368599, 873109940765431070, 1723524583324093984, 110977915524768122, 205523925685400500,
         1557538243450644145, 596255378525649918, 1660234311539958599, 1778869997548291596, 1502929442471444752,
         2011041224934678062, 976999276461207191, 299047177137221801, 1768147812576660332, 1365241051039944945,
         339845264753828808, 338177498650360859, 1541849212542666073, 512512206666816351, 366176694137736881,
         1427866902590238348, 1901352149028320077, 980690434077471834, 547612900060999927, 440403915173060771,
         2186189471025225847, 712547633346947502, 1405527247790932083, 847940375941653213, 379232457086030072,
         1155350385225519221, 568334929966423719, 1588678860911502335, 632597907596435059, 2303088507697585779,
         2203593598496018499, 401998265258132385, 1274470318549269414, 1981502111369464173, 620794699672402785,
         659892347987874070, 1080837720050919716, 1178497514486968190, 1694862185198288729, 503360452493406266,
         1401764526202632226, 1079439774640848180, 1436143587600248974, 739656437103085200, 1415897126043975742,
         318530970300847059, 949542236762456863, 2237475037151497725, 1141270158447753493, 833913017607544319,
         1613761979566894583, 1187539061920901505, 1975538700076788811, 1223969339665043320,
         1418121695575739496, 1369100512183171272],
        [1758426461858698312, 965365488286768773, 1703346441743126657, 1762784241922636284, 716042322565387540,
         1110853719534651860, 57506563652686492, 838727479550634564, 1082636226378482417, 1348484356917986390,
         1720372350978982919, 1241883087124931897, 361679113657972945, 720433610630797939, 57968974610545096,
         850535481772967366, 611791605100360195, 1208550132088437803, 1561068142528832848, 2662096424693202,
         2272005282452877337, 724575788541486983, 1344648193880622102, 804538942828528766, 92760730228048027,
         993090257743735974, 286785215429783306, 984365201973288023, 400821414621316444, 1379048364047586208,
         720455784159192385, 722729898864855936, 662171862886500102, 274655559890433538, 1596658653041296075,
         230117649494758475, 1058682450511224350, 744403489731186477, 1803461786564664828, 1863084026736552970,
         2281349539356141447, 1824352345109249500, 385282673040866497, 1657256394417291416, 2244889800033437826,
         1374084313144276834, 1446033029236275689, 2066532958085233346, 1359146662721091126,
         2160942293751064746, 499133954986498326, 1978777819965811314, 2275592508583382026, 1004189732771057208,
         2256458337378950240, 223865076026037745, 1324811268927594100, 100775521383383736, 885896412999398395,
         2292394638421159733, 483507374032440056, 2235949585210378459, 716306739587483085, 1697670337010853719,
         538343888607264301, 1744983512659606478, 343981791039746111, 1991773790767872477, 237237038733719123,
         2252746632473157885, 211311645193258271, 2238391591237301384, 1982916584933322248, 1623110274942190159,
         231616986851349715, 1702197838485543700, 1444255381494669787, 2191950179549041915, 1500807354596368775,
         1786176085821440878, 2190914504203751524, 1456940403417483715, 342670382210209374, 2053954687016252293,
         1270084851437757527, 2095848151477744322, 94837956732254865, 2219778448427847156, 275217274352977059,
         2215162532383274790, 1571183205760722246, 1227381464362988592, 1010043456706110057, 266756186393216503,
         918794838454833776, 1216767326165072010, 409112435725675790, 1050949148475592060, 2017374420125007056,
         1365360136487033415, 1045066892334153871, 305592579266007545, 2047416485587801838, 913997788746244246,
         806739497089626636, 1628156380473706444, 24525324454322813, 104448596761453350, 1346062807897531205,
         277051278387475866, 1513805725792048436, 1097409548522419201, 1201021145525391328, 70687732435925863,
         560639205034286900, 854947859192503591, 658896564124910768, 1828262494289317028, 1724427592165531258,
         1058114924210953567, 329988358101689785, 1088546156183973597, 2066610522124628330, 833676259291159664,
         804310844303211114, 1877124887546555817, 1822234730034014301, 1454448473341514576, 56745916861920898,
         1601792357933513593, 1998037649752200210, 1347668378080840179, 1340727819866657767,
         1399627060449438210, 660602863993381579, 1243014500103516392, 1019132376409109904, 974004478645089517,
         953715333708863382, 878780880476063844, 532040086468374207, 372776695775029083, 1935025542473226368,
         962202168363034276, 1994877601827876325, 385240227023819486, 1673301867390583303, 1258240320841811613,
         1468841961140741114, 1044322871188247688, 2305135602644301207, 1281945621518355175,
         1694887256724382113, 1845411424819901387, 1148675762529229689, 638912688349701945, 2045583484916473850,
         2298172310723632840, 1534666527987864972, 1875515117780768004, 2152459606434515890,
         1880963931627384332, 1884168618584704864, 2246928310081769978, 537489191914112158, 28183301139892063,
         356978078979264236, 411923661787866412, 2267517672053685781, 709103777793337348, 1379926963900447906,
         1920590963903474386, 485229302081547952, 2033584132122185477, 637726483315038709, 1968795164202433029,
         130405537475552105, 1757927897100153523, 1312416298902356142, 2130078393733190595, 332148990983021795,
         766635192903173568, 214063447237433678, 849856365785601076, 192360858327277631, 483647207114795940,
         2225363327551351580, 2149840690516079975, 1248433590692570986, 1173891698928297563,
         1504837601148203192, 1455562957510268478, 224553674835339806, 1512177974836875359, 157096900527336564,
         896590049431845266, 509241087611895860, 1731050427214635746, 2303229323133249709, 755427530754931471,
         995402841398927059, 1556670056159963283, 1338291846781469690, 314923106957567425, 989092843395776482,
         162087199749852607, 1324485371079280231, 1705477417740400528, 991858825769862374, 27599258029081682,
         1445983085903388686, 1230858877021348737, 2090789484242904086, 89678461817866436, 2249368204362114194,
         1385105974558830969, 1826300101280458925, 505302733923635975, 683655583971685946, 11831315139018117,
         191186825369038002, 55671564864779616, 560818541069201500, 742930041343091353, 603763144787268609,
         2259650492905646293, 2120548726374591649, 1970119912336228597, 477286068662573084, 893378913640444959,
         1154961390195173280, 263741922815851269, 1117637550615678792, 306929876919031952, 1189206353713198377,
         2150090563960427419, 226760246847461444, 570908357334528249, 295497489378306419, 406773781232143136,
         2019721457223340678, 1203241888054761863, 61041035127281027, 172450830632015426, 1133445665390697568,
         763803139191469562, 2257808343864191072, 1048902408437080403, 1740080472315927592, 1898175356955260338,
         1887281491218379017, 918018382383665557, 711793685540355318, 1109210035184783141, 2127935576280134751,
         1825998840733297350]],
    12: [[537959477672646300, 245618738963975811, 268860607727989169, 474355379353010054, 1511698345210945996,
          624022879445331318, 1276978359959916627, 41675606086892645, 959924911084842104, 334516048813209047,
          268592911919744135, 188344460398302894, 1104915318128761967, 1775126172038959804, 730247352651137783,
          1431879717087348193, 1561471348152528173, 2298134290183964020, 322368885571546422, 583660613951431137,
          472819990795901550, 969637985471521227, 816273398359454052, 1626059736292276949, 1669579688782903829,
          1554556357289386164, 206603323217940268, 925474250560997111, 1014939695188912755, 763135434502193639,
          1335627603356309761, 2095581840244671488, 307656468449584344, 120938275730698855, 364195379077320346,
          1906574350638921707, 1937771164961279517, 1540312096465980665, 1355283065072378020, 574635799029057439,
          228472116827787915, 1229248813033505435, 829321940838851385, 2202974184712415824, 1281611766906986645,
          1520333121992751877, 1319971899229851353, 1179257406939079873, 463077758995908832, 109008418824553667,
          188469903216354400, 2044029453200637899, 1148936949831837333, 935881378106590367, 1285270021648022994,
          45024452531139106, 187745424472701205, 811930273337278937, 214774532623257919, 525242105943587727,
          1230596569200800655, 679660430137261847, 2019649562105326877, 25590983140413215, 740119081695946928,
          635969105575619498, 1945078648984533634, 968571601118862862, 192554574902747369, 1561305020671413771,
          1726953377370963856, 696991574243222241, 1232388181984757347, 2138991684189937413, 561784323530167478,
          345563047681144397, 446848217089027047, 303404563961126835, 15271964089425620, 1744968581406547676,
          2096536202301845107, 246327133265134689, 510595836118309319, 1438517275225595977, 2243151433672733500,
          129709142878777121, 282405117618443594, 1776888087441473840, 2184425867093769692, 728276773842100725,
          863786377484248311, 941495988223724037, 1953420703679489166, 1621219562752450148, 989877362086521648,
          484804943208873378, 256650815408593975, 393012719160175364, 571905086055350143, 2292444461806859660,
          730050974087090738, 305448841880697451, 2240223500257813795, 1830003721405235747, 137095792751649739,
          2277038276655581817, 1546262639459949508, 1599841575537950429, 1133393255511674642, 406431693751207227,
          1737761108825183922, 1127404808801490806, 1666807674806718459, 476828818810039028, 377888285565504556,
          879033513228997581, 1399095471557289610, 415271388156366004, 130700804959753379, 1557602612200605126,
          2098092467375966906, 1963188523517012016, 355077706030551347, 2009322453424248396, 440050636760143232,
          1023647496862994730, 2092508592095440632, 1873110879482437651, 62447808116183247, 1879359547009586136,
          1926303447307884007, 1287176539313101438, 699892031886676378, 842075445152135371, 2106591164386302895,
          1798450252874107147, 545175109765692541, 848084917333178634, 1943277404882343971, 728340632071164769,
          259294432042120143, 238028089327806829, 1422826034505481793, 1560820916234724914, 2098350762394948944,
          1366778574487861009, 2294102142688065669, 340900604194719214, 721369108620517670, 352792318934658227,
          487598431216990156, 1498135967655365537, 1841107279229126134, 688652287342801942, 1503951422440218599,
          492827135913292983, 715503796958113522, 542198888226314791, 167922428085622580, 2140030257727834596,
          487469631435206989, 1903783499052674783, 1003972328142740104, 493764601069740113, 724929017235697952,
          42448937302983985, 1347591659009370890, 2166312802740367610, 1122463878038905349, 1849530664682520357,
          1977817968689837237, 2231688773225100141, 2037219479608418077, 2254577709350735155, 667040205124517548,
          1839832158274691284, 574719207528980050, 1070328411899585637, 489305665967860458, 1953971321177828714,
          163854714868266323, 1803199925366316759, 1909788517050587863, 339428156376042002, 1970494878473648964,
          1559065765736373268, 1634347975043230700, 1770060463354423973, 411115492882927907, 2117615417514392766,
          1538123693355220015, 1133124857017165940, 1131264601402437701, 2048235463013698980, 1652035274117321925,
          1344062829056152461, 393595644622495662, 982909833378078366, 1181946761201846828, 799234964004277777,
          875309111121273804, 1217639342500510828, 1101079512084824895, 1485601534159892279, 1215115451947026129,
          1820180195079045883, 990854909626498654, 1175991817584355293, 1600679417481394695, 23142712934593007,
          752264715745849514, 1039575536435439023, 2174987863607422326, 102384954690375486, 145133977131387402,
          687029923300242811, 582737710478128709, 1070671852419060625, 1418744861509060052, 618892612741284317,
          336754335803768902, 1473531416681296727, 1261667667298004928, 1652263684937739915, 1758902970739352024,
          564282824078432243, 313539632621458960, 1276776459204854805, 274681849395045767, 1071933359522142335,
          2108511364681295739, 602390935253589546, 1574606504774067949, 1920475675276894875, 1831784852893220289,
          10465410999495908, 2241998518007229379, 889695102408764449, 1362623548986395038, 1211348800356785336,
          507269868839589541, 1907876289023649050, 47116677925755991, 320452864137267838, 2062083084027217296,
          311782024317458652, 1367963975195259073, 2116172890974555329, 314865494239377011, 1528326954278541410,
          1100202901349287677, 587617176010024264, 91254881110607637, 131987433501732362, 221747562162139922,
          923104073342188970],
         [2122292216861183229, 622381871430236099, 806989952376234033, 616516566848131545, 225222271217833034,
          1956889255784500428, 1895136219992171811, 391551085017406881, 2036103943384198496, 658857820640231632,
          383873026327820909, 2144858693797024496, 856900107172079291, 1220589679131101519, 1994572233985375032,
          1430904178410063425, 1901086000843021515, 1389289309588120245, 1383676471832445103, 1407641698124090566,
          2216157786746578562, 1615877722966478395, 904857911410129078, 2282289184949904621, 648740023142615145,
          1983406782588737323, 514807914170822265, 1768166930727305719, 428814327177719795, 889478948297132853,
          987207992285542053, 500224262073429955, 2171869963939455926, 1594541377747943009, 1951253999542807958,
          1270461535556634811, 248063028326501828, 1283551374817380276, 1755252973276408435, 742618610746267044,
          2074616042726853331, 1302839127546548502, 909990794597603780, 1338970434634242657, 764740921889580314,
          571080684947795859, 1977316817256594540, 60652229766918526, 827610811977299109, 330679062285753162,
          1766126224076048546, 1837649732944779472, 1288941722464395623, 672089648402822929, 1579182112870338063,
          513690373412868141, 1423246448457582888, 423522018128110607, 1546436371466771091, 192494378530633387,
          508929872324746305, 70248842163032146, 1027041240799567065, 1937007521195567938, 28212293734127547,
          1249327180368884901, 1562883448137478948, 147635618501707950, 1797797664273657041, 1211365184308047810,
          2279695790544424286, 828226755495738291, 2154215132688827903, 810612879949930903, 2165837935095948955,
          633522951231934143, 2242825174703670194, 889705521196453793, 2096064088654971255, 1723755985818675047,
          2183960023198517461, 1373042738676748838, 1381330593834847812, 2143617453834434913, 810525555982130642,
          1761115337211431072, 1327567657062902591, 1737358316160623839, 326309865390949181, 1372097754697049119,
          139654826738421092, 460065803068098814, 560704828672380818, 2086137841288443955, 89466402827271025,
          181100598448378438, 1416709592002367793, 912839571177199157, 1309315297069206179, 847140645498712325,
          1966193410969627052, 484909947046907211, 2150670442478439555, 404033046712730781, 658420122192664604,
          1021012240837591124, 533454105638325242, 2006127756399147965, 279092028869289924, 240103241799584817,
          841214367866264409, 916672187622547510, 706672344176874730, 769708005263803725, 58902332392405700,
          765972334526621127, 1795834391109642875, 1696900227454967611, 1523386437203947474, 2125555407071626845,
          1541431461552966314, 1127937586231838594, 2077514414874456998, 1042026649982594452, 1021801759338777475,
          659202887166530584, 2285222443334364130, 1809621997676874911, 1787926149827218899, 328871298504144136,
          2269163579335617145, 307315833992001897, 553610498686764198, 374694167022396628, 2253640368396504785,
          668018863677860726, 1991804572868364559, 950809975337056841, 2004801452852715912, 561444304100016309,
          990244892955700588, 602002064166593635, 1075318628377622301, 662277627862302960, 255719510335085152,
          16892428281252446, 232859536093383577, 307239749138547801, 1474156334065249250, 849578101983035029,
          2155601885509205927, 2148713739157070840, 1598131751991821731, 1395073168579091899, 270988343668192404,
          868792358802764001, 969530601637421364, 1230427238220622914, 1453207151494274772, 463871999091459368,
          1986248546570015157, 1450365039023910027, 1452959715926927749, 281696835519283544, 1549015044809614013,
          1259560894743403597, 941264490167564413, 824546270617699554, 674847723394517276, 380056020399355911,
          1125632614412238387, 163285315784502345, 89700722281776219, 1474027665794567112, 1658631424609962587,
          504744607784597589, 968754219871908829, 60073372395982215, 534026998286563876, 125822151366851074,
          5039438711901756, 316604921851625904, 2241983972716702765, 1103823166334682226, 1025078752427972822,
          2283529964456672540, 120265407740080390, 2074910783453437545, 820135656003578235, 952508371216211197,
          1683970610282279335, 1901625537395212044, 1049279816928912333, 1489285291999133770, 2125901084917186655,
          493809736389317121, 834773396684350551, 640114348534976861, 1373190502642303646, 553967292700623080,
          1392463544299750173, 1113492553069375102, 1992481447815066954, 1673874484677886590, 2200263470190003950,
          4100204781328690, 1764074196574361142, 1338095684148644215, 1164646051165801740, 297574906787548193,
          61292961590441985, 411945436029650472, 1817066340567761760, 842994068682839475, 1829560119125875168,
          1208967688531566033, 927891359311460396, 697609803351874805, 978838649645066549, 2148117982215047973,
          1122180488447126068, 1669245634667010303, 883925113877861635, 459549019374151833, 667584674373426705,
          1615606488813809630, 476130644380333808, 2075859158876141345, 1112049107363834934, 697936063104363055,
          1700477879528203724, 2280234839423053479, 2254761301566861445, 833628392562882575, 674246041863435157,
          237515221359704837, 1156585252957966558, 1767674803208510430, 288138254817544730, 1763247454960683771,
          953477399610546858, 1499498819838944325, 329519401576509934, 2298233140467988149, 280920493465625940,
          725510153966689976, 1714804496813980566, 868309567602943848, 1698018841518429414, 721634017570130549,
          860329129398357599, 1002055198255752132, 1781742471221598523, 2224193495151051210, 427077448392067782,
          774704489614066719]]
}
INPUT_TRIM = 128
B = TypeVar('B', BinaryIO, bytes)


def generate_meta_id(title: str, creators: str='', extra: str='', version: int=0) -> str:

    assert version == 0, "Only version 1 supported"

    title, creators, extra = trim(title, creators, extra)

    title = normalize_text(title)
    creators = normalize_creators(creators)
    extra = normalize_text(extra)

    concat = '\u0020'.join((title, creators, extra)).rstrip('\u007C')

    a = sliding_window(concat, width=2) * 3
    b = sliding_window(concat, width=3) * 2
    c = sliding_window(concat, width=4)
    n_grams = a + b + c

    hash_digests = [sha256(s.encode('utf-8')).digest() for s in n_grams]
    simhash_digest = similarity_hash(hash_digests)
    meta_id_digest = b'\x00' + simhash_digest[:7]

    return base64.b32encode(meta_id_digest).rstrip(b'=').decode('ascii')


def generate_instance_id(data: B) -> str:

    leaf_node_digests = [sha256d(b'\x00' + chunk) for chunk in data_chunks(data)]
    top_hash_digest = top_hash(leaf_node_digests)
    instance_id_digest = b'\x30' + top_hash_digest[:7]
    return base64.b32encode(instance_id_digest).rstrip(b'=').decode('ascii')


def generate_data_id(data: B) -> str:

    chunks = data_chunks(data)
    min_hash = minimum_hash(chunks)
    hash_values = [sha256(str(value).encode('utf-8')).digest() for value in min_hash]
    sim_hash = similarity_hash(hash_values)
    return base64.b32encode(b'\x20' + sim_hash[1:8]).rstrip(b'=').decode('ascii')

def top_hash(hashes: List[bytes]) -> bytes:

    size = len(hashes)
    if size == 1:
        return hashes[0]

    pairwise_hashed = []

    for i in range(0, len(hashes) - 1, 2):
        pairwise_hashed.append(hash_inner_nodes(hashes[i], hashes[i + 1]))

    if size % 2 == 1:
        pairwise_hashed.append(hash_inner_nodes(hashes[-1], hashes[-1]))

    return top_hash(pairwise_hashed)


def sha256d(data: bytes) -> bytes:
    return sha256(sha256(data).digest()).digest()


def hash_inner_nodes(a: bytes, b: bytes) -> bytes:
    return sha256d(b'\x01' + a + b)


def data_chunks(data: B) -> Generator[bytes, None, None]:

    if not hasattr(data, 'read'):
        data = BytesIO(data)

    section = data.read(640)
    counter = 0
    while True:
        if counter < 100:
            if len(section) < 640:
                section += data.read(640)
            if len(section) == 0:
                break
            boundary = chunk_length(section, 40, 20, 640, 0x016118, 0x00a0b1)
        else:
            if len(section) < 65536:
                section += data.read(65536)
            if len(section) == 0:
                break
            boundary = chunk_length(section, 4096, 2048, 65536, 0x0003590703530000, 0x0000d90003530000)

        yield section[:boundary]
        section = section[boundary:]
        counter += 1


def chunk_length(data: bytes, norm_size: int, min_size: int, max_size: int, mask_1: int, mask_2: int) -> int:
    data_length = len(data)
    i = min_size
    pattern = 0

    if data_length <= min_size:
        return data_length

    while i < min(norm_size, data_length):
        pattern = (pattern << 1) + CHUNKING_GEAR[data[i]]
        if not pattern & mask_1:
            return i
        i = i + 1
    while i < min(max_size, data_length):
        pattern = (pattern << 1) + CHUNKING_GEAR[data[i]]
        if not pattern & mask_2:
            return i
        i = i + 1
    return i


def generate_image_hash(image_path: str) -> str:

    image = Image.open(image_path)
    image = image.convert("L").resize((32, 32), Image.BICUBIC)

    # get image pixels as matrix
    pixels = [[list(image.getdata())[32 * i + j] for j in range(32)] for i in range(32)]

    # discrete cosine transform over every row
    dct_row_lists = []
    for pixel_list in pixels:
        dct_row_lists.append(discrete_cosine_transform(pixel_list))

    # discrete cosine transform over every column
    dct_row_lists_t = list(map(list, zip(*dct_row_lists)))
    dct_col_lists_t = []
    for dct_list in dct_row_lists_t:
        dct_col_lists_t.append(discrete_cosine_transform(dct_list))
    dct_lists = list(map(list, zip(*dct_col_lists_t)))

    # extract upper left 8x7 corner as flat list
    flat_list = [x for sublist in dct_lists[:7] for x in sublist[:8]]

    # compare every value with median and generate hash
    med = sum(sorted(flat_list)[27: 29]) / 2
    hash = ''
    for value in flat_list:
        if value > med:
            hash += '1'
        else:
            hash += '0'
    return base64.b32encode(b'\x10' + int(hash, 2).to_bytes(8, 'big', signed=False)[:7]).rstrip(b'=').decode('ascii')


def discrete_cosine_transform(value_list: Sequence[float]) -> Sequence[float]:
    N = len(value_list)
    dct_list = []
    for k in range(N):
        value = 0.0
        for n in range(N):
            value += value_list[n] * math.cos(math.pi * k * (2 * n + 1) / (2 * N))
        dct_list.append(2 * value)
    return dct_list

def normalize_text(text: str) -> str:

    whitelist = 'LNS'
    decomposed = unicodedata.normalize('NFD', text)
    chars = []

    for c in decomposed:
        cat = unicodedata.category(c)
        if cat.startswith('Z'):
            chars.append(' ')
        elif cat[0] in whitelist:
            chars.append(c.lower())

    filtered = ''.join(chars)
    collapsed = '\u0020'.join(filtered.split())
    normalized = unicodedata.normalize('NFC', collapsed)

    return normalized


def normalize_creators(text: str) -> str:

    nonum = re.sub("\d+", "", text, flags=re.UNICODE)

    creators = []

    for creator in nonum.split(';'):

        if ',' in creator:
            creator = ' '.join(reversed(creator.split(',')[:2]))
        ncreators = normalize_text(creator)

        tokens = ncreators.split()
        if not tokens:
            continue
        if tokens[0] == tokens[-1]:
            abridged = tokens[0]
        else:
            abridged = tokens[0][0] + tokens[-1]
        creators.append(abridged)

    return '\u0020'.join(sorted(creators))


def trim(*text: str) -> List[str]:

    trimmed = []
    for t in text:
        trimmed.append(unicodedata.normalize('NFKC', t)[:INPUT_TRIM])
    return trimmed


def sliding_window(text: str, width: int) -> List:

    assert width >= 2, "Sliding window width must be 2 or bigger."
    idx = range(max(len(text) - width + 1, 1))
    return [text[i:i + width] for i in idx]


def similarity_hash(hash_digests: Sequence[ByteString]) -> ByteString:

    n_bytes = len(hash_digests[0])
    n_bits = (n_bytes * 8)
    vector = [0] * n_bits

    for digest in hash_digests:

        assert len(digest) == n_bytes
        h = int.from_bytes(digest, 'big', signed=False)

        for i in range(n_bits):
            vector[i] += h & 1
            h >>= 1

    minfeatures = len(hash_digests) * 1. / 2
    shash = 0

    for i in range(n_bits):
        shash |= int(vector[i] >= minfeatures) << i

    return shash.to_bytes(n_bytes, 'big', signed=False)


def minimum_hash(hash_digests: Sequence[ByteString]) -> Sequence[int]:
    max_hash = (1 << 32) - 1
    max_int64 = (1 << 64) - 1
    num_perm = 128
    hashvalues = [max_hash] * num_perm
    for digest in hash_digests:
        hash_value = struct.unpack('<I', sha1(digest).digest()[:4])[0]
        a, b = MINHASH_PERMUTATIONS[1]
        new_hashvalues = []
        for x in range(num_perm):
            new_hashvalue = (((a[x] * hash_value + b[x]) & max_int64) % ((1 << 61) - 1)) & max_hash
            new_hashvalues.append(min(new_hashvalue, hashvalues[x]))
        hashvalues = new_hashvalues
    return hashvalues


def c2d(code: str) -> ByteString:

    return base64.b32decode(code + '===')


def c2i(code):

    digest = c2d(code)
    return int.from_bytes(digest[1:8], 'big', signed=False)


def hamming_distance(ident1: int, ident2: int) -> int:

    return bin(ident1 ^ ident2).count('1')